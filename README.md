# ZETIN Counter 2023

<img src="Res/counter1.png" width="60%" height="60%">

- 2023년에 제작한 라인트레이서 기록 측정 장비(이하 계수기)를 의미한다.
- 출발 지점과 종료 지점에 센서가 있으며, 이 센서를 지나는 시점을 이용하여 기록을 정밀하게 측정한다.
- 본 코드는 계수기 코드 중에서 자체 제작 프로그래밍 언어인 Starlight를 사용하여 작성하였으며, 계수기의 장비들을 객체로 보며, 객체지향적으로 작성하였다.
- [Starlight 언어](https://github.com/PJungKim/Counter2023/blob/main/starli3t.md)는 Binary Code를 SD카드에서 가져오면, 하드웨어 내의 가상머신이 이 코드를 해석해서 시간을 측정하는 방식으로 작동하며, 가상머신을 구성한 코드는 Starlight Counter 레포지토리를 참고하자.

## 1. 개요

### 1.1. 계수기의 변화

- 2022년도부터 계수기에 LED Matrix 디스플레이가 추가되었고, 센서 또한 1cm 간격으로 3개를 달았다. 4cm 높이규정에 따라 4cm 이하 높이에 3개의 센서를 달아서 라인트레이서를 정밀하게 감지하도록 설계하였다.
- 2023년도, 제틴 내 CAD 스터디 모임을 구성하여 계수기 하드웨어 프레임을 3D프린터로 인쇄하였고, 안정화 작업을 거쳐 현재의 계수기가 탄생하였다.

### 1.2. LED 디스플레이

- 2022년도 이전까지는 LED 디스플레이 없이 작동하였으며, 전원을 넣으면 계수기가 작동하는 방식으로 설계하였다. 또한, 계수기 하드웨어에는 오로지 센서만 노출되어 있었으며, 버튼과 디스플레이는 필요할 때만 노출하고, 평상시에는 감추는 방식으로 작동하였다.
- 2022년도부터는 디스플레이를 장착하여 라인트레이서의 진로 방향, 기록 확인 등을 하드웨어에서만 할 수 있게 설계하였다. 다만, 22년도 계수기는 안정성 문제가 잦았으며, **무엇보다도 DC트레이서 1등이 수동계수로 측정되었다는 흑역사를 남겼다!**
- 2023년도에는 계수기 안정화에 동아리 차원에서 투자를 과감하게 하였고, 3D프린터로 계수기를 출력하는 데 성공하였다. 현재까지 가장 성공한 계수기라고 볼 수도 있다. CAD스터디 내에서 LED 디스플레이를 여러 개 달자는 이야기가 나왔으나, 전력 이슈, 모듈 이슈 등 여러 이슈가 있었고, 합의 끝에 LED 디스플레이는 2모듈만 다는 것으로 확정되었다. 다만, 최대 4개 모듈까지 설치할 수 있으며, SPI 인터페이스 방식을 지원한다면 디스플레이가 아니어도 다른 모듈을 붙일 수도 있다. 2024년 계수기에는 영상 인식 장치 등과 같은 추가 모듈을 붙이자는 이야기가 있으니 참고.

### 1.2.1. LED 디스플레이 색상
- 2022년도 처음 디스플레이를 제작할 때는 RGB 모듈을 사용한다는 이야기가 있었으나, LED 디스플레이에 비용이 많이 지원되지 못하는 특성상, 동아리방 내에 있는 부품을 최대한 활용하는 것으로 결정하게 되고, 초록색 대신 흰색을 사용하기로 하면서 RBW 매트릭스 사용이 확정되었다.
- 2023년도 초, RBW 매트릭스가 규격에 맞지 않는 문제가 생겼고, 규격에 맞게 RYB 매트릭스를 다시 만들었다! 다만, 일부 LED가 부족하여 RBW 매트릭스에서 부품을 꺼내 오면서 RBW 매트릭스는 더 이상 사용하지 않게 되었다.
- 2023년도 여름, RYB 매트릭스를 계수기에 사용하는 것이 거의 확정되었지만, 패턴이 일부 떨어져 나가면서 한 줄이 나가게 되었고, 도로 RGB LED Matrix 모듈로 교체되었다. 해당 모듈은 22년도 '제틴시계 만들기' 프로젝트 취소분으로, 2개의 모듈이 남아 있어서 계수기에 사용하게 되었다고 한다.
- 디스플레이를 2개 하자는 의견을 반영하여 3D프린팅 후 하나 더 있는 RGB LED Matrix 모듈을 추가로 달았다. 기존 계획과 달라진 점이라면, 측면에는 8×16 크기로 달려고 했지만, RYB 매트릭스 불용 문제로 인해 측면에도 8×8 크기로 사용한 것이다.
- 결국 2023년 대회 이후부터는 RGB 매트릭스 디스플레이를 계속 사용하였다. 다행인건, 제틴 시계 프로젝트 취소분을 그대로 사용해서 어느 정도 원가절감이 가능했던 것.

### 1.3. 계수기 제작자

- 계수기 프레임 : D. H. KIM, K. H. LEE
- 계수기 H/W 회로 : P. J. KIM, C. H. KIM
- 계수기 H/W 코드 : P. J. KIM(Pierre De Starlit)

## 2. 사용 언어

- 계수기 가상 머신 파트(Starlight Counter 레포지토리) : C
- 계수기 작동 파트(Counter2023) : [Starlight](https://github.com/PJungKim/Counter2023/blob/main/starli3t.md)

### 2.1. 사용 언어에 관하여

- 지금까지는 계수기는 오로지 C언어로만 모든 구간을 코딩하였으나, 2023년도에 본인이 만든 Starlight라는 언어를 사용하여 계수기 스테이트 머신을 구현해 보자는 아이디어가 떠올랐고, 무조건 도전해 보았다. 결과는 매우 성공적이었다.
- 계수기의 각종 부품들을 객체로 보고 작동 과정을 구성하였기 때문에 C언어로 구현했을 때보다는 훨씬 편하게 작성하였다.

### 2.1.1. 장점
  - 간결한 코딩이 가능하다. Python만큼은 아니지만, Starlight 언어도 반복 연산자 지원 등 축약 요소가 상당히 제공되며, 객체-메소드 형식으로 코딩할 수 있어서 디스플레이가 여러 개 있어도 쉽게 제어할 수 있었다.
  - C언어의 경우 헤더 파일과 레퍼런스 파일을 따로 만들어서 번거롭지만, Starlight에서는 헤더 파일이 필요 없도록 설계했기 때문에 파일 관리하기 훨씬 편하다. 실제로도 기능에 따라 파일을 여러 개로 분할해서 코딩하였다.
 
### 2.1.2. 단점
  - 빠른 속도를 요구하는 부분에 취약하다. 따라서 버튼 스테이트 머신 같은 부분은 C언어 레벨에서 처리해서 사용한다. 따라서 버튼 함수 자체는 Starlight 규격으로 나왔지만, 실제로는 C언어의 버튼 스테이트 머신 함수를 호출한다!
  - 별도의 가상머신이 필요하다. Starlight 언어는 하드웨어 레벨까지 컴파일하지 않고, 하드웨어마다 통일된 규격의 가상머신 규격을 따로 만들어 컴파일한다. 따라서 컴파일러는 언제나 똑같이 컴파일하지만, 이를 해석하는 가상머신은 프로세서에 따라 따로 설계해야 한다. 현재는 STM32F407VET6 규격의 가상머신만 설계된 상태이다. 그러나 STM32 계열의 가상머신 1개를 제작하면 비슷한 계열의 가상머신을 추가로 제작할 수 있어 그렇게 나쁘진 않다.

### 2.1.3. 계수기 하드웨어 코딩 방향
  - Starlight 언어를 이어받는 경우 : C로 처리해야 하는 부분이 있다면, 가상 머신의 주소를 추가하는 방식으로 Starlight와 C가 호환되게 코딩하면 된다. 추가적인 GPIO 등이 필요하다면 그렇게 사용하자. 어지간해서는 가상 머신 변경은 그렇게 추천하지는 않는다. 다만, Starlight 언어로 짜인 코드를 변경하여 업데이트하는 것도 나쁘지는 않다.
  - Starlight 언어를 이어받지 않아도 상관은 없다. 하지만, 그렇게 할 경우 2022년도 이전 코드를 참조해야 한다.
  - 하드웨어 자체를 새로 만들어도 상관은 없지만, 23년도 계수기는 오래 사용할 목적으로 제작되었기 때문에 동아리 재정상황을 고려해서라도 새로 만드는 쪽은 피하는 것이 좋겠다.

  - 결론적으로 Starlight 언어를 이어 받아 추가할 부분 추가하는 식으로 코딩을 진행하자. 무엇보다도 SPI 포트가 2개 여유가 있다. SPI 포트를 적극적으로 활용해서 모듈을 추가해 보면 어떨까 한다.

## 3. 여담

  - 단국대생들이 23년도 계수기를 극찬하였다. 무엇보다도 [LED 디스플레이가 인상적이었다고 한다](https://mazehz.cafe24.com/zbxe/?mid=Freeboard2&document_srl=191060). ~~그렇게 단국대 계수기에도 디스플레이가 추가되는건가...?~~

