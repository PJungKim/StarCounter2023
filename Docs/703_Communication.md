# 계수기 통신규격

## 1. 개요

- 계수기 하드웨어 및 소프트웨어 간 통신 규격을 정하는 문서입니다.

- 계수기 통신에 관한 세부 규격은 계수기 하드웨어 제작자와 소프트웨어 제작자의 협의가 필요합니다.


## 2. UART 통신하기

- Starlit UART 규격은 아래와 같으며, 레지스터 값을 바꾸면 UART 방식을 변경할 수 있으니 참고 바랍니다(Starlit 언어로도 레지스터 제어 가능).

  |물리량|값|
  |------|------|
  |Baud Rate|9600 baud [^속도]|
  |Data Bits|8-Bit with no Parity|
  |Endian|Little Endian(Default)|

### 2.1 수신

  - Starlit에서 `FTDI_Begin()` 함수를 사용해 UART를 초기화해 주세요. 아두이노의 Serial.begin과 비슷합니다.
     ```
     FTDI_Begin(9600);   /// 9600Baud로 UART 초기화
     FTDI_Begin(38400);  /// 38400Baud로 UART 초기화
     FTDI_Begin(115200); /// 115200Baud로 UART 초기화
     ```
 
  - String 변수를 하나 추가합니다. 이 String에 UART로 입력받은 데이터를 가져올 수 있습니다.
    ```
    #re():str; ///UART 통신해서 입력받을 값 가져오기
    ```

  - `FTDI_Scan(시간, 문자열 포인터)` 함수를 사용하면 문자열에 FTDI에서 들어온 데이터를 받을 수 있습니다.
    ```
    FTDI_Scan(10, _re); ///문자열 re에 FTDI 입력 값을 받아옴. 이때, 데이터 수신 후 10ms 이내에 데이터가 수신되지 않을때까지 반복.
    ```

  - 문자열 비교 함수 : `strcmp` 또는 `strncmp` 함수를 사용한다.
    ```
    if(!strcmp(_re, "R")){ ///입력받은 텍스트가 "R"과 같으면 실행
    ```

### 2.2 송신

  - Starlit에서는 `FTDI_Print` 함수를 사용하여 계수기 S/W에 데이터를 송신할 수 있습니다. 이를 이용해 결과를 전송할 수 있습니다.
    ```
    FTDI_Print("R"); ///UART에 "R"을 송신한다.
    ```

    ```
    FTDI_Print("%06d!" % recentTime); ///출발 시점부터 현재 시점까지의 데이터를 문자열로 바꿔서 송신한다.
    ```

  - Starlit에서 `<<` 연산자를 사용해서 간단하고 편리하게 결과를 전송할 수도 있습니다.

    ```
    FTDI_cout << "%06d!" % recentTime; ///FTDI에 현재 기록 출력
    ```
    
## 3. 2023년도 기준 상황별 UART 통신 규격

- 주의사항 : 대/소문자 구분되므로 소문자로 보내서 통신이 안된다고 뭐라 하진 말자.

### 3.1 주행 시작 : `S`

  - 라인트레이서 주행이 시작되면 계수기 소프트웨어에 `S`를 전송한다.
  - `S`를 전송받으면 소프트웨어쪽 화면에 시간을 측정하기 시작한다.

### 3.2 예외 발생 : `R`

  - 하드웨어 또는 소프트웨어 어느 한 쪽에 `R` 신호가 전송되면 그 때의 기록은 취소된다.(그런 상황이 발생하지 않았음에도 R 신호가 보내지면 기록이 사라져 수동계수가 필요해지니 실수로 Reset 버튼 누르지 않도록 주의하자.)
  - 소프트웨어쪽에서 `R`을 보내면 하드웨어에서 예외 처리 후 소프트웨어쪽으로 다시 `R`을 보내므로 S/W쪽에서는 Reset 버튼을 누르면 즉시 초기화해도 되고, `R` 신호를 받아 초기화해도 무방하다.

### 3.3 도착 : `E`

  - 정상적으로 도착하면 `E`를 보낸다. End라는 뜻이며, 계수기 S/W의 타이머를 정지시키는 역할만 담당하며, `E`신호가 기록을 인정할 정도로 중요한 신호는 아니다.
  - 다만, `E` 신호를 보낸 후 기록 시간을 송신해야 기록이 인정되니 `E` 신호를 보내지 않아 기록이 인정되지 않는 참사만은 막는 게 좋다.

### 3.4 기록 : `SSSsss!`

  - 기록은 10진수로 ms단위로 6자리만 보내면 된다. 실제 라인트레이서 주행시간은 최대 5분, 즉 300초를 넘기는 일은 없으니 초단위 3자리, 소숫점 아래 3자리 해서 6자리를 전송한다.
  - 맨 앞의 숫자는 절대 분단위가 아니다. 즉, 1분 30초를 130000으로 보내서 잘못 인식하는 일은 없길 바란다.(작년에 100000으로 보낸 것을 1분으로 해석해 기록이 40초씩 사라지는 일도 있었다가 고쳤다.)
  - 저 위에 `SSSsss!`라고 보냈다고 진짜로 SSSsss를 보내진 말자.
  - 맨 마지막에 느낌표를 붙여야 하는데, 느낌표를 붙이지 않으면 S/W쪽에서 데이터를 받기가 상당히 곤란해진다.

  - Tip : FTDI_cout을 사용해 `"%06d!"`의 형식으로 시간을 보내면 된다.

  [^속도]: 당시에는 안정적인 전송이 중요했기에 9600Baud로 하였으나 안정적으로 돌아가기만 한다면 UART 통신 속도 증속도 고려해 볼만하다.

  
